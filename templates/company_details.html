<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Company Details</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>

<body>
  <div class="container my-4">
    <h2>{{ company_name }} Overview</h2>

    <!-- Nav Tabs -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <a class="nav-link active" data-bs-toggle="tab" href="#financials">Financial Data</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#news">Company News</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" data-bs-toggle="tab" href="#analytics">Analytics</a>
      </li>
    </ul>

    <div class="tab-content">

      <div class="card p-3 mb-4">
        <h5>Download Financial Data</h5>
        <form class="row g-2" onsubmit="downloadFinancials(event)">
          <div class="col-md-3">
            <label for="year_from" class="form-label">From</label>
            <input type="number" id="year_from" class="form-control" placeholder="e.g. 2022">
          </div>
          <div class="col-md-3">
            <label for="year_to" class="form-label">To</label>
            <input type="number" id="year_to" class="form-control" placeholder="e.g. 2024">
          </div>
          <div class="col-md-3">
            <label for="format_financials" class="form-label">Format</label>
            <select id="format_financials" class="form-select">
              <option value="csv" selected>CSV</option>
              <option value="excel">Excel</option>
            </select>
          </div>
          <div class="col-md-3 align-self-end">
            <button type="submit" class="btn btn-primary w-100">Download</button>
          </div>
        </form>
      </div>
      
      <!-- Financials Tab -->
      <div class="tab-pane fade show active" id="financials">
        <table class="table table-bordered">
          <thead>
            <tr>
              <th>Year</th>
              <th>Revenue (ETB)</th>
              <th>EBITDA (ETB)</th>
              <th>Net Profit (ETB)</th>
              <th>Debt-to-Equity</th>
            </tr>
          </thead>
          <tbody id="financial-data-body"></tbody>
        </table>
        <div class="mb-3">
          <a href="/download/financials/{{ company_id }}" class="btn btn-primary">Download Financial Data (CSV)</a>
        </div>
        
        <canvas id="financialChart" height="150"></canvas>
      </div>

      <!-- News Tab -->
      <div class="tab-pane fade" id="news">
        <div id="news-container" class="row row-cols-1 row-cols-md-2 g-3 mt-3"></div>
      </div>

      <!-- Analytics Tab -->
      <div class="tab-pane fade" id="analytics">
        <h4 class="mt-3">30-Day Stock Price & Volume</h4>
        <canvas id="priceChart" height="150"></canvas>
        <canvas id="volumeChart" height="150" class="mt-4"></canvas>
      </div>

    </div>
  </div>

  <!-- Financials Script -->
  <script>
    const companyId = {{ company_id }};

    fetch(`/financials/${companyId}`)
      .then(response => response.json())
      .then(data => {
        const tableBody = document.getElementById("financial-data-body");
        const years = [], revenue = [], netProfit = [], ebitda = [], debtToEquity = [];

        if (data.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-warning">No financial data available.</td></tr>`;
          return;
        }

        data.forEach(record => {
          const row = `<tr>
            <td>${record.year}</td>
            <td>${record.revenue.toLocaleString()}</td>
            <td>${record.ebitda.toLocaleString()}</td>
            <td>${record.net_profit.toLocaleString()}</td>
            <td>${record.debt_to_equity}</td>
          </tr>`;
          tableBody.innerHTML += row;

          years.push(record.year);
          revenue.push(record.revenue);
          ebitda.push(record.ebitda);
          netProfit.push(record.net_profit);
        });

        const ctx = document.getElementById("financialChart").getContext("2d");
        new Chart(ctx, {
          type: "line",
          data: {
            labels: years,
            datasets: [
              { label: "Revenue (ETB)", data: revenue, borderColor: "rgba(54, 162, 235, 1)", backgroundColor: "rgba(54, 162, 235, 0.2)", tension: 0.4 },
              { label: "EBITDA (ETB)", data: ebitda, borderColor: "rgba(255, 206, 86, 1)", backgroundColor: "rgba(255, 206, 86, 0.2)", tension: 0.4 },
              { label: "Net Profit (ETB)", data: netProfit, borderColor: "rgba(75, 192, 192, 1)", backgroundColor: "rgba(75, 192, 192, 0.2)", tension: 0.4 }
            ]
          },
          options: {
            responsive: true,
            plugins: { legend: { position: "top" } },
            scales: { x: { title: { display: true, text: "Years" } }, y: { beginAtZero: false, title: { display: true, text: "Values (ETB)" } } }
          }
        });
      });
  </script>

  <!-- News Tab Script -->
  <script>
    const newsItems = [
      { date: "2025-05-20", title: "Wegagen Bank Reports Record Q2 Profit", summary: "Wegagen Bank announced a 15% rise in Q2 net profit compared to last year." },
      { date: "2025-05-18", title: "Wegagen Launches New Mobile Banking Service", summary: "The bank unveils its latest digital platform targeting retail investors." },
      { date: "2025-05-10", title: "New Capital Market Tax Regulations Announced", summary: "Ethiopian Securities Exchange updates tax policy for listed companies." }
    ];

    const newsContainer = document.getElementById("news-container");
    newsItems.forEach(item => {
      const card = `<div class="col">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-subtitle mb-2 text-muted">${item.date}</h6>
            <h5 class="card-title">${item.title}</h5>
            <p class="card-text">${item.summary}</p>
          </div>
        </div>
      </div>`;
      newsContainer.innerHTML += card;
    });
  </script>

  <!-- Analytics Tab Script -->
  <script>
    fetch(`/stocks/${companyId}?date_from=2025-05-01&date_to=2025-05-30`)
      .then(response => response.json())
      .then(data => {
        const dates = [], prices = [], volumes = [];

        data.forEach(record => {
          dates.push(record.date);
          prices.push(record.close);
          volumes.push(record.volume);
        });

        const priceCtx = document.getElementById("priceChart").getContext("2d");
        new Chart(priceCtx, {
          type: "line",
          data: {
            labels: dates,
            datasets: [{
              label: "Stock Price (ETB)",
              data: prices,
              borderColor: "rgba(54, 162, 235, 1)",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              tension: 0.3,
              fill: true
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: false } }
          }
        });

        const volumeCtx = document.getElementById("volumeChart").getContext("2d");
        new Chart(volumeCtx, {
          type: "bar",
          data: {
            labels: dates,
            datasets: [{
              label: "Volume",
              data: volumes,
              backgroundColor: "rgba(255, 159, 64, 0.7)"
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } }
          }
        });
      });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function downloadFinancials(event) {
      event.preventDefault();
      const yearFrom = document.getElementById("year_from").value;
      const yearTo = document.getElementById("year_to").value;
      const format = document.getElementById("format_financials").value;
      const companyId = {{ company_id }};
    
      let url = `/download/financials/${companyId}?format=${format}`;
      if (yearFrom) url += `&year_from=${yearFrom}`;
      if (yearTo) url += `&year_to=${yearTo}`;
    
      window.open(url, "_blank");
    }
    </script>
    
</body>
</html>
