<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Market Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-light">

  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Capital Market Platform</a>
    </div>
  </nav>

  <div class="container my-4">
    <h1 class="mb-4">Market Overview</h1>

    <!-- Search Bar with Static Autocomplete -->
    <div class="mb-4 position-relative">
      <input type="text" class="form-control" id="search-bar" placeholder="Search for a company..." onkeyup="showSuggestions()">
      <ul id="suggestions" class="list-group position-absolute w-100" style="z-index: 1000; display: none;"></ul>
    </div>

    <!-- Download Buttons -->
    <div class="mb-3">
      <a href="/download/companies" class="btn btn-primary">Download Companies Data (CSV)</a>
      <a href="/download/macro_indicators" class="btn btn-secondary">Download Macro Data (CSV)</a>
    </div>
    
    
    <!-- Market Summary Card -->
    <div id="market-summary" class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">Market Summary</h5>
        <p class="card-text">Total Companies: <span id="total-companies">5</span></p>
        <p class="card-text">Total Market Cap: <span id="market-cap">2,500,000 ETB</span></p>
        <p class="card-text">Last Updated: <span id="last-updated">2025-05-26</span></p>
      </div>
    </div>
 <!-- Download Macroeconomic Data -->
    <div class="card p-3 mb-4">
      <h5>Download Macroeconomic Data</h5>
      <form class="row g-2" onsubmit="downloadMacro(event)">
        <div class="col-md-3">
          <label for="date_from" class="form-label">From</label>
          <input type="date" id="date_from" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="date_to" class="form-label">To</label>
          <input type="date" id="date_to" class="form-control">
        </div>
        <div class="col-md-3">
          <label for="format" class="form-label">Format</label>
          <select id="format" class="form-select">
            <option value="csv" selected>CSV</option>
            <option value="excel">Excel</option>
          </select>
        </div>
        <div class="col-md-3 align-self-end">
          <button type="submit" class="btn btn-primary w-100">Download</button>
        </div>
      </form>
    </div>
    
    <!-- Top Movers -->
    <div id="top-movers" class="row row-cols-1 row-cols-md-3 g-3 mb-4">
      <div class="col">
        <div class="card border-success h-100">
          <div class="card-body">
            <h5 class="card-title">Wegagen Bank</h5>
            <p class="card-text">Price: 53 ETB</p>
            <p class="card-text text-success">+2.5%</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card border-danger h-100">
          <div class="card-body">
            <h5 class="card-title">Ethio Telecom</h5>
            <p class="card-text">Price: 28 ETB</p>
            <p class="card-text text-danger">-1.8%</p>
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card border-success h-100">
          <div class="card-body">
            <h5 class="card-title">Dashen Bank</h5>
            <p class="card-text">Price: 47 ETB</p>
            <p class="card-text text-success">+3.1%</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Stock Price Chart -->
    <div class="card mb-4">
      <div class="card-body">
        <canvas id="stockChart" height="150"></canvas>
      </div>
    </div>

  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Search Autocomplete Script -->
  <script>
    const companies = ["Wegagen Bank", "Ethio Telecom", "Dashen Bank", "Hibret Bank", "CBE"];
    function showSuggestions() {
      const input = document.getElementById("search-bar").value.toLowerCase();
      const suggestions = document.getElementById("suggestions");
      suggestions.innerHTML = "";
      if (input.length === 0) {
        suggestions.style.display = "none";
        return;
      }
      const matches = companies.filter(c => c.toLowerCase().includes(input));
      matches.forEach(match => {
        const item = document.createElement("li");
        item.className = "list-group-item";
        item.textContent = match;
        suggestions.appendChild(item);
      });
      suggestions.style.display = matches.length ? "block" : "none";
    }
  </script>

  <!-- Stock Chart Script -->
  <script>
    const labels = ["2025-05-17", "2025-05-18", "2025-05-19", "2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-24", "2025-05-25", "2025-05-26"];
    const stockPrices = [50, 51, 49, 52, 53, 52, 54, 53.5, 55, 54];
    const ctx = document.getElementById("stockChart").getContext("2d");
    const stockChart = new Chart(ctx, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Stock Price (ETB)",
          data: stockPrices,
          borderColor: "rgba(75, 192, 192, 1)",
          backgroundColor: "rgba(75, 192, 192, 0.2)",
          tension: 0.3,
          pointRadius: 5,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: false
          }
        }
      }
    });
  </script>
  <script>
    // Fetch market summary from backend API
    fetch("http://localhost:5001/market")
      .then(response => response.json())
      .then(data => {
        console.log(data); // log response for now
  
        // Update the dashboard card
        document.getElementById("total-companies").textContent = data.total_companies;
        document.getElementById("market-cap").textContent = `${data.market_cap} ETB`;
        document.getElementById("last-updated").textContent = data.last_updated;
      })
      .catch(error => console.error("Error fetching market summary:", error));
  </script>
  <!-- Download Macro Indicators Script -->
  <script>
    function downloadMacro(event) {
      event.preventDefault();
      const dateFrom = document.getElementById("date_from").value;
      const dateTo = document.getElementById("date_to").value;
      const format = document.getElementById("format").value;
    
      let url = `/download/macro_indicators?format=${format}`;
      if (dateFrom) url += `&date_from=${dateFrom}`;
      if (dateTo) url += `&date_to=${dateTo}`;
    
      window.open(url, "_blank");
    }
    </script>
    
</body>
</html>
